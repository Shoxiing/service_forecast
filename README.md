# Сервис по прогнозу цен на криптовалюты 

## Архитектура сервиса

Этот проект предоставляет веб-сервис для прогнозирования цены на криптовалюту  Bitcoin (BTC), используя комбинацию анализа временных рядов и модели глубинного обучения.   

![Архитектура](https://github.com/Shoxiing/for/blob/main/archt.png)

Сервис состоит из нескольких компонентов:

- **Airflow** : оркестрирование - dag airflow запускает скрипт в 00:00 по UTC ежедневно.
- **Binance API** : данные передаются на модели: DL модель, а также в базу данных на PostgreSQL.
- **База данных (PostgreSQL)** : имеет в себе 2 таблицы: одна для прогнозов моделей и вторая для хранения и наполнения датасета.
- **DL Model Predict** : в данной работе используется DL модель - предобученная FNN (4-layer). Данные от Binance API перед подачей в модель подготавливаются и передаются для получения прогноза в режиме инференса - повышение/понижение цены через 24 часа. Прогноз отправляется в БД.
- **3x ARIMA Fit and Predict** : модели ARIMA обращаются к датасету в БД для обучения, используют наблюдение полученной последней цены от API Binance для выдачи прогноза цены через 24 часа.
- **Select Prediction** : выбор прогноза от моделей на завтрашний день - для выбора наиболее точного прогноза из нескольких моделей считается ошибка MAE по предыдущему прогнозу цены BTC .Выбранный прогноз отправляется в БД.
- **Telegram Bot** : пользователь запрашивает прогноз цены BTC в долларах США, отправляется SQL запрос на БД, в ответ пользователь получает прогноз на завтрашний день в виде цены и её направления (повышение/понижение).


## Описание используемых моделей
Для обучения использовался датасет с Binance API - ежедневные цены с различными видами объемов торгов, количеством сделок, период данных: 01-09-2019 - 01-06-2024.

Прогнозирование цен в сервисе осуществляется моделями:
- Для прогноза направления цены (задача классификации) использовалась DL-модель 4-х слойная FNN
- Для прогноза цены (задача регрессии) 3 ARIMA модели с различной предобработкой входных данных: без предобработки, с логарифмированием, с преобразованием Бокса-Кокса различными параметрами (p, d, q)x(P, D, Q).


EDA и обучение моделей на датасете Binance API [здесь](notebooks%20-%20EDA%20and%20model%20selection/model_selection.ipynb).


## Структура проекта
- в содержит docker файл docker-compose.yaml для развертывания проекта целиком ( Airflow, БД к ней и БД для проекта, и сам tg_bot)
- **dags_airflow**: dag_01.py - содержит DAG файл для запуска пайплайна в Airflow, functions.py - функции для работы пайплайна, dockerfile, в папке [models](airflow_dags/models) находится предобученная модель FNN, используемая для прогноза.
- **notebooks - EDA and model selection**: Jupyter ноутбуки с разведочным анализом данных (EDA), предобработкой данных, обучением и выбора моделей.
- **tg_bot_crypto**: код Telegram бота, который отправляет прогнозы пользователям.

### Стек:

- Docker, Docker Compose
- Python 3.11
- Apache Airflow
- PostgreSQL

### Алгоритм запуска локально веб-серивса по прогнозу цены BTC

1. **Клонируйте репозиторий:**

    ```sh
    git clone https://github.com/Shoxiing/hse_forecast.git
    ```

2. **Развертывание проекта в docker:**

    ```sh
    docker-compose up -d
    ```
3. В БД загрузить dataset.csv [скачать](https://drive.google.com/file/d/167KvpGBYilRRi6ej3HWP-Nv_i9Ix8AT_/view?usp=drive_link) для предварительного наполнения датасета и обучения ARIMA моделей:
   
    Один из способов:

   ```python
     import pandas as np
     from sqlalchemy import create_engine

     dataset = pd.read_csv(csv_path)

     #для примера: логин-admin, пароль-root
     engine = create_engine('postgresql+psycopg2://admin:root@127.0.0.1:5432/postgres') 
     dataset.to_sql('dataset', engine, if_exists='append', index=False)
   
    ```



